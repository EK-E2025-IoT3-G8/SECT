{% extends "base.html" %}
<!-- Denne template arver layoutet fra base.html -->

{% block title %}EEG Impedans Test – Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- Venstre side: graf over historiske målinger -->
    <div class="col-12 col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                Historiske impedansmålinger – 4 elektroder
            </div>
            <div class="card-body">
                <div id="sensor-plot" style="height:400px;"></div>

                <p class="text-muted mt-2" id="sensor-info">
                    Henter data fra API...
                </p>
            </div>
        </div>
    </div>

    <!-- Højre side: status + knap til at starte ny test -->
    <div class="col-12 col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                Status
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-3">
                    <li>API: <span class="badge bg-secondary" id="api-status">Ukendt</span></li>
                    <li>Database: <span class="badge bg-secondary" id="db-status">Ukendt</span></li>
                    <li>Seneste test-tid: <span class="badge bg-secondary" id="last-timestamp">N/A</span></li>
                </ul>

                <h6>Seneste impedans pr. kanal</h6>
                <ul class="list-unstyled small">
                    <li>Kanal 0: <span id="last-ch0">N/A</span></li>
                    <li>Kanal 1: <span id="last-ch1">N/A</span></li>
                    <li>Kanal 2: <span id="last-ch2">N/A</span></li>
                    <li>Kanal 3: <span id="last-ch3">N/A</span></li>
                </ul>

                <h6>Seneste bus-måling</h6>
                <ul class="list-unstyled small">
                    <li>Busspænding: <span id="last-bus">N/A</span></li>
                    <li>Strøm: <span id="last-current">N/A</span></li>
                </ul>

                <hr>

                <button class="btn btn-primary w-100" id="start-test-btn">
                    Start ny test på Raspberry Pi
                </button>
                <p class="mt-2 small" id="rpc-status"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // ------------------------------------------------------------
    // Hent historiske målinger fra /api/sensor-data og opdater graf + status
    // ------------------------------------------------------------
    async function loadSensorData() {
        const statusEl = document.getElementById("api-status");
        const dbStatusEl = document.getElementById("db-status");
        const infoEl = document.getElementById("sensor-info");
        const lastTsEl = document.getElementById("last-timestamp");

        const lastCh0El = document.getElementById("last-ch0");
        const lastCh1El = document.getElementById("last-ch1");
        const lastCh2El = document.getElementById("last-ch2");
        const lastCh3El = document.getElementById("last-ch3");
        const lastBusEl = document.getElementById("last-bus");
        const lastCurrentEl = document.getElementById("last-current");

        try {
            const res = await fetch("/api/sensor-data");
            if (!res.ok) {
                throw new Error("API-fejl: " + res.status);
            }

            const data = await res.json();

            const timestamps = data.timestamps || [];
            const ch0 = data.ch0 || [];
            const ch1 = data.ch1 || [];
            const ch2 = data.ch2 || [];
            const ch3 = data.ch3 || [];
            const bus = data.bus_voltage || [];
            const current = data.current || [];
            const channels = data.channels || [0, 1, 2, 3];

            // --------------------------------------------------------
            // Plotly-graf – 4 kurver, én pr. elektrode (kanal 0–3)
            // --------------------------------------------------------
            const traces = [];

            if (timestamps.length > 0) {
                traces.push({
                    x: timestamps,
                    y: ch0,
                    mode: "lines+markers",
                    name: "Elektrode 0"
                });
                traces.push({
                    x: timestamps,
                    y: ch1,
                    mode: "lines+markers",
                    name: "Elektrode 1"
                });
                traces.push({
                    x: timestamps,
                    y: ch2,
                    mode: "lines+markers",
                    name: "Elektrode 2"
                });
                traces.push({
                    x: timestamps,
                    y: ch3,
                    mode: "lines+markers",
                    name: "Elektrode 3"
                });
            }

            const layout = {
                title: (data.sensor_name || "EEG Impedans Test") + " – impedans pr. kanal",
                xaxis: { title: "Tid" },
                yaxis: { title: "Impedans (" + (data.unit || "Ohm") + ")" }
            };

            if (traces.length > 0) {
                Plotly.newPlot("sensor-plot", traces, layout);
                infoEl.textContent = "Viser " + (data.count ?? timestamps.length) + " tests fra databasen.";
            } else {
                document.getElementById("sensor-plot").innerHTML = "";
                infoEl.textContent = "Ingen data i databasen endnu. Kør en test med knappen til højre.";
            }

            // --------------------------------------------------------
            // Opdater "seneste måling"-felter
            // --------------------------------------------------------
            if (timestamps.length > 0) {
                const lastIndex = timestamps.length - 1;
                lastTsEl.textContent = timestamps[lastIndex];
                lastTsEl.classList.remove("bg-secondary");
                lastTsEl.classList.add("bg-info");

                // Seneste impedans pr. kanal
                lastCh0El.textContent = ch0[lastIndex].toFixed(1) + " " + (data.unit || "Ohm");
                lastCh1El.textContent = ch1[lastIndex].toFixed(1) + " " + (data.unit || "Ohm");
                lastCh2El.textContent = ch2[lastIndex].toFixed(1) + " " + (data.unit || "Ohm");
                lastCh3El.textContent = ch3[lastIndex].toFixed(1) + " " + (data.unit || "Ohm");

                // Seneste bus-spænding og strøm
                if (bus.length > 0) {
                    lastBusEl.textContent = bus[lastIndex].toFixed(2) + " V";
                } else {
                    lastBusEl.textContent = "N/A";
                }
                if (current.length > 0) {
                    lastCurrentEl.textContent = current[lastIndex].toFixed(1) + " mA";
                } else {
                    lastCurrentEl.textContent = "N/A";
                }
            } else {
                lastTsEl.textContent = "N/A";
                lastCh0El.textContent = "N/A";
                lastCh1El.textContent = "N/A";
                lastCh2El.textContent = "N/A";
                lastCh3El.textContent = "N/A";
                lastBusEl.textContent = "N/A";
                lastCurrentEl.textContent = "N/A";
            }

            // --------------------------------------------------------
            // Status-badges
            // --------------------------------------------------------
            statusEl.textContent = "OK";
            statusEl.classList.remove("bg-secondary", "bg-danger");
            statusEl.classList.add("bg-success");

            dbStatusEl.textContent = "OK";
            dbStatusEl.classList.remove("bg-secondary", "bg-danger");
            dbStatusEl.classList.add("bg-success");

        } catch (err) {
            console.error(err);
            infoEl.textContent = "Kunne ikke hente data fra API'et.";
            statusEl.textContent = "Fejl";
            statusEl.classList.remove("bg-secondary", "bg-success");
            statusEl.classList.add("bg-danger");

            dbStatusEl.textContent = "Ukendt";
            dbStatusEl.classList.remove("bg-success");
            dbStatusEl.classList.add("bg-secondary");
        }
    }

    // ------------------------------------------------------------
    // RPC: Start ny test på Raspberry Pi via /api/start-remote-test
    // ------------------------------------------------------------
    async function startRemoteTest() {
        const btn = document.getElementById("start-test-btn");
        const rpcStatus = document.getElementById("rpc-status");

        btn.disabled = true;
        rpcStatus.textContent = "Sender forespørgsel til Raspberry Pi...";

        try {
            const res = await fetch("/api/start-remote-test", {
                method: "POST"
            });

            if (!res.ok) {
                throw new Error("Fejl fra API: " + res.status);
            }

            const data = await res.json();

            // Byg en lille tekst med resultatet
            if (data.resistances && data.resistances.length >= 4) {
                rpcStatus.textContent =
                    "Ny test gemt kl. " + data.timestamp +
                    " – Z0=" + data.resistances[0].toFixed(1) +
                    ", Z1=" + data.resistances[1].toFixed(1) +
                    ", Z2=" + data.resistances[2].toFixed(1) +
                    ", Z3=" + data.resistances[3].toFixed(1) +
                    " " + (data.unit || "Ohm");
            } else {
                rpcStatus.textContent = data.message || "Test gennemført (men ingen impedansdata).";
            }

            // Efter en succesfuld test: hent data igen, så grafen og status opdateres
            await loadSensorData();

        } catch (err) {
            console.error(err);
            rpcStatus.textContent = "Fejl ved remote test: " + err.message;
        } finally {
            btn.disabled = false;
        }
    }

    // ------------------------------------------------------------
    // Kør når siden loader
    // ------------------------------------------------------------
    document.getElementById("start-test-btn")
        .addEventListener("click", startRemoteTest);

    loadSensorData();
</script>
{% endblock %}
